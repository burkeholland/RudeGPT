@using RudeGPT.Shared
@using System.Text.Json

@inject IJSRuntime JSRuntime
@inject StateContainer StateContainer

<p class="menu-label has-text-white is-size-5">Chat History</p>
@foreach (var chatHistoryItem in StateContainer.ChatHistory)
{
  <div class="mt-4 is-clickable">
    <span class="menu-item has-text-white is-size-6" @onclick="() => HandleHistoryItemClick(chatHistoryItem)" href="#">
      <div class="columns is-vcentered">
        <div class="column">
          @chatHistoryItem.Title
        </div>
        <div class="column is-narrow">
          <button class="delete" @onclick="() => HandleHistoryItemDelete(chatHistoryItem)"></button>
        </div>
      </div>
    </span>
  </div>
}

@code {
  protected override void OnInitialized()
  {
    StateContainer.OnChange += StateHasChanged;
  }

  protected override async Task OnInitializedAsync()
  {
    await StateContainer.LoadHistoryFromLocalStorage();
  }

  private void HandleHistoryItemClick(ChatSession chatHistoryItem)
  {
    StateContainer.ChatSession = chatHistoryItem;
  }

  private void HandleHistoryItemDelete(ChatSession chatHistoryItem)
  {
    StateContainer.ChatHistory.Remove(chatHistoryItem);
    StateContainer.SaveHistoryToLocalStorage();

    if (StateContainer.ChatSession == chatHistoryItem)
    {
      StateContainer.ChatSession = new ChatSession();
    }
  }

  public void Dispose()
  {
    StateContainer.OnChange -= StateHasChanged;
  }
}