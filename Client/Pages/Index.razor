@page "/"

@using System.Text
@using System.Text.Json
@using Azure.AI.OpenAI
@using RudeGPT.Shared

@inject HttpClient Http
@inject IJSRuntime JSRuntime
@inject StateContainer StateContainer

<div class="is-flex-grow-1 no-scrollbar">
  @* <NavBar></NavBar> *@
  <div class="columns is-full-height is-gapless">
    <Sidebar></Sidebar>
    <div class="column is-flex is-flex-direction-column">
      <p class="level-item has-text-centered title">
        RudeGPT
      </p>
      <hr class="mt-0 mb-4" />
      <div class="overflow-scroll is-flex-grow-1 no-scrollbar">
        @foreach (var chatMessage in StateContainer.ChatSession.Messages)
        {
          <MessageItem chatMessage="@chatMessage"></MessageItem>
        }
      </div>
      <ChatBox OnUserMessageSubmit="@GetCompletion"></ChatBox>
    </div>
  </div>
</div>

@code {

  protected override void OnInitialized()
  {
    StateContainer.OnChange += StateHasChanged;
  }

  private async Task GetCompletion(string message)
  {
    // add the user message to the messages list
    StateContainer.ChatSession.Messages.Add(new Message { Role = ChatRole.User, Content = message });

    // create a new assistant message that serves as a placeholder until the response is received
    var assistantMessage = new Message { Role = ChatRole.Assistant, Content = "..." };

    StateContainer.ChatSession.Messages.Add(assistantMessage);

    // call the /api/completions endpoint and pass in the messages object
    var response = await Http.PostAsJsonAsync<List<Message>>("api/completions", StateContainer.ChatSession.Messages);
    if (response.Content is not null)
    {
      var responseContent = await response.Content.ReadAsStringAsync();
      var content = JsonSerializer.Deserialize<string>(responseContent);

      assistantMessage.Content = content;
    }

    // if there are only 2 items in the StateContainer.ChatSession.Messages list, add it to the chatHistory list
    if (StateContainer.ChatSession.Messages.Count == 2)
    {
      // get the first four words of the first message as the title
      StateContainer.ChatSession.Title = StateContainer.ChatSession.Messages[0].Content.Split(' ').Take(4).Aggregate((a, b) =>
      $"{a} {b}");

      StateContainer.AddToChatHistory(StateContainer.ChatSession);
    }

    StateContainer.SaveHistoryToLocalStorage();
  }

  public void Dispose()
  {
    StateContainer.OnChange -= StateHasChanged;
  }
}
